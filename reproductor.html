<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reproductor - Canchita TV</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://vjs.zencdn.net/8.6.1/video-js.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      font-family: Arial, sans-serif;
    }
    
    .player-container {
      position: relative;
      width: 100%;
      max-width: 1280px;
      margin: 0 auto;
      background: #000;
    }
    
    .video-wrapper {
      position: relative;
      padding-top: 56.25%;
      background: #000;
    }
    
    #video-player {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    .controls-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.8));
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .player-container:hover .controls-overlay {
      opacity: 1;
    }
    
    .control-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    
    .control-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .channel-info {
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
    }
    
    .loading-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
    }
    
    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid #fff;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error-message {
      background: #ff4444;
      color: white;
      padding: 15px;
      text-align: center;
      border-radius: 5px;
      margin: 20px;
      display: none;
    }
    
    .back-button {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      text-decoration: none;
      z-index: 100;
      transition: background 0.3s;
    }
    
    .back-button:hover {
      background: rgba(0,0,0,0.9);
    }
    
    .debug-info {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.9);
      color: #0f0;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 10px;
      max-width: 400px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
  </style>
</head>
<body>
  
  <a href="index.html" class="back-button">‚Üê Volver a la Agenda</a>
  
  <div class="loading-indicator" id="loading">
    <div class="spinner"></div>
    <p id="loading-text">Cargando stream...</p>
    <p style="font-size: 12px; opacity: 0.7;" id="loading-method">Preparando...</p>
  </div>
  
  <div class="channel-info" id="channel-info">
    <span id="channel-name">Cargando...</span>
  </div>
  
  <div class="error-message" id="error-message"></div>
  
  <div class="debug-info" id="debug-info"></div>
  
  <div class="player-container">
    <div class="video-wrapper">
      <video 
        id="video-player" 
        class="video-js vjs-default-skin vjs-big-play-centered" 
        controls 
        preload="auto"
        data-setup='{"fluid": true}'
      >
        <p class="vjs-no-js">
          Para ver este video, por favor activa JavaScript
        </p>
      </video>
    </div>
    
    <div class="controls-overlay">
      <button class="control-btn" id="play-pause">‚ñ∂ Play</button>
      <button class="control-btn" id="mute">üîá Mute</button>
      <button class="control-btn" id="pip">üì∫ PiP</button>
      <button class="control-btn" id="fullscreen">‚õ∂ Pantalla Completa</button>
    </div>
  </div>
  
  <script src="https://vjs.zencdn.net/8.6.1/video.min.js"></script>
  <script>
    // ==========================================
    // CONFIGURACI√ìN
    // ==========================================
    const WORKER_URL = 'https://melonesvideo.dinaveneca.workers.dev/';
    const EXTRACTOR_PHP = 'extractor.php';
    const PROXY_PHP = 'proxy.php';
    const USE_WORKER = false; // Desactivado por ahora (retorna 404)
    const USE_PROXY = true; // Activar proxy para evitar 403
    const DEBUG_MODE = true;
    
    // ==========================================
    // OBTENER PAR√ÅMETROS
    // ==========================================
    const urlParams = new URLSearchParams(window.location.search);
    const embedUrl = decodeURIComponent(urlParams.get('iframe') || '');
    const channelName = decodeURIComponent(urlParams.get('name') || 'Canal Desconocido');
    
    log('üì∫ Iniciando reproductor');
    log('- Embed:', embedUrl);
    log('- Canal:', channelName);
    
    document.getElementById('channel-name').textContent = channelName;
    
    // ==========================================
    // FUNCI√ìN DE DEBUG
    // ==========================================
    function log(...args) {
      console.log(...args);
      if (DEBUG_MODE) {
        const debugDiv = document.getElementById('debug-info');
        debugDiv.style.display = 'block';
        const text = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : a).join(' ');
        debugDiv.innerHTML += text + '<br>';
        debugDiv.scrollTop = debugDiv.scrollHeight;
      }
    }
    
    // ==========================================
    // INICIALIZAR PLAYER
    // ==========================================
    let player;
    
    document.addEventListener('DOMContentLoaded', function() {
      player = videojs('video-player', {
        controls: true,
        autoplay: true,
        preload: 'auto',
        fluid: true,
        responsive: true,
        liveui: true,
        html5: {
          vhs: {
            overrideNative: true,
            withCredentials: false
          },
          nativeVideoTracks: false,
          nativeAudioTracks: false,
          nativeTextTracks: false
        }
      });
      
      loadStream();
      setupCustomControls();
    });
    
    // ==========================================
    // CARGAR STREAM
    // ==========================================
    async function loadStream() {
      if (!embedUrl || embedUrl === '#' || embedUrl === '') {
        showError('No se proporcion√≥ una URL v√°lida');
        return;
      }
      
      try {
        let fullEmbedUrl = embedUrl;
        if (embedUrl.startsWith('/')) {
          fullEmbedUrl = 'https://golazoplay.com' + embedUrl;
        }
        
        log('üîÑ URL completa:', fullEmbedUrl);
        
        // M√âTODO 1: Worker (si est√° activado)
        if (USE_WORKER) {
          document.getElementById('loading-method').textContent = 'M√©todo 1: Cloudflare Worker';
          log('üöÄ M√©todo 1: Worker...');
          
          const workerSuccess = await tryWorker(fullEmbedUrl);
          if (workerSuccess) {
            log('‚úÖ Cargado con Worker');
            return;
          }
          log('‚ö†Ô∏è Worker fall√≥');
        }
        
        // M√âTODO 2: Extractor.php
        document.getElementById('loading-method').textContent = 'M√©todo 2: Extractor Local';
        log('üîß M√©todo 2: Extractor...');
        
        const videoUrl = await getVideoUrlFromExtractor(embedUrl);
        
        if (videoUrl) {
          log('‚úÖ URL obtenida:', videoUrl);
          
          // Cargar con o sin proxy seg√∫n configuraci√≥n
          if (USE_PROXY) {
            log('üîÄ Usando proxy para evitar 403');
            const proxiedUrl = `${PROXY_PHP}?url=${encodeURIComponent(videoUrl)}`;
            await loadVideoUrl(proxiedUrl);
          } else {
            await loadVideoUrl(videoUrl);
          }
          
          log('‚úÖ Stream cargado exitosamente');
          return;
        }
        
        throw new Error('No se pudo obtener la URL del video');
        
      } catch (error) {
        log('‚ùå Error fatal:', error.message);
        showError('No se pudo cargar el stream: ' + error.message);
      }
    }
    
    // ==========================================
    // OBTENER URL DEL VIDEO DESDE EXTRACTOR
    // ==========================================
    async function getVideoUrlFromExtractor(embedUrl) {
      try {
        const url = `${EXTRACTOR_PHP}?iframe=${encodeURIComponent(embedUrl)}`;
        log('üì° Llamando extractor:', url);
        
        const response = await fetch(url);
        log('üìä Respuesta:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        log('üì¶ Data:', data);
        
        if (data.url && data.url !== '') {
          return data.url;
        } else if (data.error) {
          throw new Error(data.error);
        }
        
        return null;
        
      } catch (error) {
        log('‚ùå Error en extractor:', error.message);
        return null;
      }
    }
    
    // ==========================================
    // INTENTAR CON WORKER
    // ==========================================
    async function tryWorker(embedUrl) {
      try {
        const attempts = [
          `${WORKER_URL}?url=${encodeURIComponent(embedUrl)}`,
          `${WORKER_URL}?iframe=${encodeURIComponent(embedUrl)}`
        ];
        
        for (let i = 0; i < attempts.length; i++) {
          const url = attempts[i];
          log(`üåê Worker intento ${i+1}:`, url);
          
          try {
            const response = await fetch(url, {
              method: 'GET',
              headers: {
                'Accept': 'application/json'
              }
            });
            
            log(`üìä Worker respuesta ${i+1}: ${response.status}`);
            
            if (response.ok) {
              const contentType = response.headers.get('content-type');
              
              if (contentType && contentType.includes('application/json')) {
                const data = await response.json();
                log('üì¶ Worker JSON:', data);
                
                if (data.url && data.url !== '') {
                  if (USE_PROXY) {
                    const proxiedUrl = `${PROXY_PHP}?url=${encodeURIComponent(data.url)}`;
                    await loadVideoUrl(proxiedUrl);
                  } else {
                    await loadVideoUrl(data.url);
                  }
                  return true;
                }
              }
            }
          } catch (err) {
            log(`‚ùå Worker intento ${i+1} error:`, err.message);
          }
        }
        
        return false;
        
      } catch (error) {
        log('‚ùå Worker error:', error.message);
        return false;
      }
    }
    
    // ==========================================
    // CARGAR VIDEO EN EL PLAYER
    // ==========================================
    async function loadVideoUrl(videoUrl) {
      log('üé¨ Cargando en player:', videoUrl);
      
      let videoType = 'video/mp4';
      
      // Detectar tipo de video
      if (videoUrl.includes('.m3u8') || videoUrl.includes('proxy.php')) {
        videoType = 'application/x-mpegURL';
      } else if (videoUrl.includes('.mpd')) {
        videoType = 'application/dash+xml';
      }
      
      log('üìπ Tipo detectado:', videoType);
      
      player.src({
        src: videoUrl,
        type: videoType
      });
      
      hideLoading();
      
      // Eventos del player
      player.on('loadstart', function() {
        log('‚è≥ Iniciando carga...');
      });
      
      player.on('loadedmetadata', function() {
        log('‚úÖ Metadata cargada');
      });
      
      player.on('canplay', function() {
        log('‚úÖ Listo para reproducir');
      });
      
      player.on('playing', function() {
        log('‚ñ∂Ô∏è Reproduciendo');
      });
      
      player.on('error', function(e) {
        const error = player.error();
        log('‚ùå Player error:', error);
        
        if (error) {
          let errorMsg = 'Error al reproducir';
          
          switch(error.code) {
            case 1:
              errorMsg = 'Carga abortada';
              break;
            case 2:
              errorMsg = 'Error de red';
              break;
            case 3:
              errorMsg = 'Error de decodificaci√≥n';
              break;
            case 4:
              errorMsg = 'Formato no soportado o 403 Forbidden';
              break;
          }
          
          showError(errorMsg + ' (C√≥digo: ' + error.code + ')');
        }
      });
      
      player.on('waiting', function() {
        log('‚è∏Ô∏è Buffering...');
      });
      
      player.on('stalled', function() {
        log('‚ö†Ô∏è Stream detenido');
      });
      
      // Intentar reproducir
      try {
        await player.play();
        log('‚úÖ Reproducci√≥n iniciada');
      } catch (error) {
        log('‚ÑπÔ∏è Autoplay bloqueado, click para reproducir');
      }
    }
    
    // ==========================================
    // CONTROLES PERSONALIZADOS
    // ==========================================
    function setupCustomControls() {
      document.getElementById('play-pause').addEventListener('click', function() {
        if (player.paused()) {
          player.play();
          this.textContent = '‚è∏ Pause';
        } else {
          player.pause();
          this.textContent = '‚ñ∂ Play';
        }
      });
      
      document.getElementById('mute').addEventListener('click', function() {
        if (player.muted()) {
          player.muted(false);
          this.textContent = 'üîä Unmute';
        } else {
          player.muted(true);
          this.textContent = 'üîá Mute';
        }
      });
      
      document.getElementById('pip').addEventListener('click', async function() {
        try {
          const videoElement = document.querySelector('video');
          if (document.pictureInPictureElement) {
            await document.exitPictureInPicture();
          } else {
            await videoElement.requestPictureInPicture();
          }
        } catch (error) {
          log('Error PiP:', error);
        }
      });
      
      document.getElementById('fullscreen').addEventListener('click', function() {
        if (player.isFullscreen()) {
          player.exitFullscreen();
        } else {
          player.requestFullscreen();
        }
      });
    }
    
    // ==========================================
    // UTILIDADES
    // ==========================================
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }
    
    function showError(message) {
      hideLoading();
      const errorDiv = document.getElementById('error-message');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      log('üö® Error:', message);
    }
  </script>
</body>
</html>
